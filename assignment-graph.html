<!DOCTYPE html>
<meta charset="utf-8">
<style>
  * { 
    margin:0;
  }
  p {
  margin-top: 10px;
  margin-bottom: 10px;
  }
  html {
    height: 100%;
  }
  body {
    height: 100%;
  }
  #container {
    height: 100%;
    width: 100%;
    float: left;
  }
  #infoPanel {
    height: 100%;
    width: 33%; // 0%;
    float: left;
    background: #add6ff;
    overflow: scroll;
    box-sizing: border-box;
    border-right: 1px solid black;
    padding: 15px; // 0px;
  }
  #infoPanel-title {
    font-family: Verdana;
    font-size: 150%;
    padding-top: 12px;
    text-align: center;
    padding-bottom: 12px;
  }
  #infoPanel-summary {
    font-family: Trebuchet MS;
    font-size: 100%;
    padding-top: 6px;
    padding-bottom: 3px;
    border-top: 1px solid black;
    // border-bottom: 1px solid black;
  }
  
  #graph {
    height: 100%;
    width: 67%; // 99%;
    float: right;
    background: white;
  }
  #graph svg {
    width: 100%;
    height: 100%;
  }
</style>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/viz.js@1.8.0/viz.js" type="javascript/worker"></script>
<script src="https://unpkg.com/d3-graphviz@1.3.1/build/d3-graphviz.min.js"></script>

<body>

<div id="container">
  <div id="infoPanel">
    <div id="infoPanel-title">Eurisko Assignments</div>
    <div id="infoPanel-summary"><p>
    Click on a topic to see assignment problems.
    </p></div>
  </div>
  <div id="graph"></div>
</div>

</body>

<script>

/////////////////////
/* UNDERLYING DATA */
/////////////////////

var resources = {
    103: {'summary': ['<a href="http://eurisko.us/files/all_problems_iteration_1.html#Problem-2-3" target="_blank">Create a Matrix class with methods show, add, subtract, scale, and multiply for 2x2 matrices</a>','asdf']}
}

lightPurple = '#f0c9ff'
lightGreen = '#bdffc8'
lightBlue = '#c9e4ff'
lightRed = '#ffdbdb'
lightOrange = '#ffe19c'
lightTeal = '#b0fff6'
lightOlive = '#ddff9f'

var courses = {
0: {'title': 'Prerequisites', 'color': 'gray'},
1: {'title': 'Data Structures & Algorithms', 'color': lightBlue},
}

var properties = {
  0: {
    course: 0,
    prerequisites: [],
    title: "AP Calculus BC"
  },
  103: {
    course: 1,
    prerequisites: [0],
    title: "Matrix Arithmetic"
  },
}

////////////////////
/* TEXT UTILITIES */
////////////////////

function replaceAll(string, original, replacement) {
		prevString = string
    newString = string.replace(original, replacement)
    while(prevString != newString) {
    		prevString = newString
        newString = newString.replace(original, replacement)
    }
    return newString
}

function breakupText(text, charsPerLine=20, leeway=5) {
  words = text.split(' ')
  result = ''
  counter = 0
  for(i=0; i<words.length; i++) {
  	word = words[i]
    if(counter + word.length <= charsPerLine) {
    	result += word+' '
      counter += word.length+1
    } else if(counter <= charsPerLine-leeway && counter+word.length <= charsPerLine+leeway) {
    	result += word+'\\n'
      counter = 0
    } else {
    	result += '\\n'+word+' '
      counter = word.length
    }
  }
  result = replaceAll(result, ' \\n', '\\n')
  return result.trim()
}

/////////////////
/* DOT MARKUP */
////////////////

function updateDotStyle(nodeId, key, val, which='node') {
	dotStyle[nodeId][which][key] = val 
}

function resetDotStyle() {
  for(var nodeId in properties) {
    title = properties[nodeId]['title']
    courseId = properties[nodeId]['course']
    dotStyle[nodeId] = {'node':{}, 'edges':{}}
    updateDotStyle(nodeId, 'label', breakupText(title), which='node')
    updateDotStyle(nodeId, 'color', 'black', which='node')
    updateDotStyle(nodeId, 'fillcolor', courses[courseId]['color'], which='node')
  }
}

function styleDot(dotUnstyled, dotStyle) {
		lines = []
    for(var nodeId in properties) {
    	prerequisites = properties[nodeId]['prerequisites']
    	line = '{'+prerequisites.join(';')+'} -> '+nodeId
      edgeAttr = dotStyle[nodeId]['edges']
      for(var attr in edgeAttr) {
          val = edgeAttr[attr]
          line += ' ['+attr+'="'+val+'"]'
        }
      lines.push(line)
     }
    
    for(var nodeId in dotStyle) {
        line = nodeId
        nodeAttr = dotStyle[nodeId]['node']
        for(var attr in nodeAttr) {
          val = nodeAttr[attr]
          line += ' ['+attr+'="'+val+'"]'
        }
        lines.push(line)
    }
    dot = dotUnstyled.substring(0, dotUnstyled.length - 2)
    dot += '\n\n'
    dot += lines.join('\n')
    dot += '\n}\n'
    return dot
}

var dotStyle = {}
resetDotStyle()

var dotUnstyled = `
digraph {
node [style="filled"] [width=0] [fontcolor=black] [fontsize=20] [fontname="helvetica-bold"] [fixedsize=false] [fillcolor="#e3e3e3"] [color=black] [penwidth=0]
edge [arrowsize=2.5] [penwidth=1.01]
rankdir=BT;
`; // penwidth=1.01 is necessary for the edges to go back to that original size when rendering. for some reason it doesn't update correctly when pendwith=1. (weird!)

var dot = styleDot(dotUnstyled,dotStyle)

///////////////////////
/* DISPLAY UTILITIES */
///////////////////////

function updateInfoPanel(nodeId) {
courseId = properties[nodeId]['course']
  courseColor = courses[courseId]['color']
  document.getElementById('infoPanel').style.background = courseColor
  
  label = dotStyle[nodeId]['node']['label']
  label = replaceAll(label,'\\n',' ')
  document.getElementById('infoPanel-title').innerHTML=label;
  
  nodeResources = resources[nodeId]
  
  if(nodeResources){
      summary = nodeResources['summary']
  } else {
  		summary = 'Nothing here yet!'
  }
  
  if(summary){
      summaryHTML = summary.join('</p><hr><p>')
      summaryHTML = '<p>'+summaryHTML+'</p>'
  } else {
  		summaryHTML = ''
  }
  
  document.getElementById('infoPanel-summary').innerHTML = summaryHTML
  
  MathJax.Hub.Queue(["Typeset",MathJax.Hub,'infoPanel-summary']); // typeset any new mathjax | https://docs.mathjax.org/en/v1.0/typeset.html
}

function attributer(datum, index, nodes) {
    margin = 20; // to avoid scrollbars
    var selection = d3.select(this);
    if (datum.tag == "svg") {
        var width = window.innerWidth;
        var height = window.innerHeight;
        datum.attributes.width = width - margin;
        datum.attributes.height = height - margin;
    }
}

function resizeSVG() {
    var width = window.innerWidth;
    var height = window.innerHeight;
    var svg = d3.select("#graph").selectWithoutDataPropagation("svg");
    svg
        .attr("width", width - 40)
        .attr("height", height - 40);

    var margin = 20; // to avoid scrollbars

    var d = svg.datum();
    d.attributes['width'] = width - margin;
    d.attributes['height'] = height - margin;
};

///////////////////////////////
/* RENDERING & INTERACTIVITY */
///////////////////////////////

var graphviz = d3.select("#graph").graphviz().attributer(attributer).logEvents(false);

function render() {
    graphviz
        .transition(function() {
            return d3.transition()
                .delay(0)
                .duration(0);
        })
        .renderDot(dot)
        .on("end", interactive);
}

function interactive() {
    nodes = d3.selectAll('.node');
    nodes
   			.on("click", onClick)
}

function onClick() {
  var nodeId = d3.select(this).selectAll('title').text();
  nodeId = parseInt(nodeId)
  updateInfoPanel(nodeId)
};

//////////
/* MAIN */
//////////

d3.select(window).on("resize", resizeSVG);
render(dot);

</script>
